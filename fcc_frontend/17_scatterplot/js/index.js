var dataObjs = [
  {
    "Time": "36:50",
    "Place": 1,
    "Seconds": 2210,
    "Name": "Marco Pantani",
    "Year": 1995,
    "Nationality": "ITA",
    "Doping": "Alleged drug use during 1995 due to high hematocrit levels",
    "URL": "https://en.wikipedia.org/wiki/Marco_Pantani#Alleged_drug_use"
  },
  {
    "Time": "36:55",
    "Place": 2,
    "Seconds": 2215,
    "Name": "Marco Pantani",
    "Year": 1997,
    "Nationality": "ITA",
    "Doping": "Alleged drug use during 1997 due to high hermatocrit levels",
    "URL": "https://en.wikipedia.org/wiki/Marco_Pantani#Alleged_drug_use"
  },
  {
    "Time": "37:15",
    "Place": 3,
    "Seconds": 2235,
    "Name": "Marco Pantani",
    "Year": 1994,
    "Nationality": "ITA",
    "Doping": "Alleged drug use during 1994 due to high hermatocrit levels",
    "URL": "https://en.wikipedia.org/wiki/Marco_Pantani#Alleged_drug_use"
  },
  {
    "Time": "37:36",
    "Place": 4,
    "Seconds": 2256,
    "Name": "Lance Armstrong",
    "Year": 2004,
    "Nationality": "USA",
    "Doping": "2004 Tour de France title stripped by UCI in 2012",
    "URL": "https://en.wikipedia.org/wiki/History_of_Lance_Armstrong_doping_allegations"
  },
  {
    "Time": "37:42",
    "Place": 5,
    "Seconds": 2262,
    "Name": "Jan Ullrich",
    "Year": 1997,
    "Nationality": "GER",
    "Doping": "Confessed later in his career to doping",
    "URL": "https://en.wikipedia.org/wiki/Jan_Ullrich#Operaci.C3.B3n_Puerto_doping_case"
  },
  {
    "Time": "38:05",
    "Place": 6,
    "Seconds": 2285,
    "Name": "Lance Armstrong",
    "Year": 2001,
    "Nationality": "USA",
    "Doping": "2001 Tour de France title stripped by UCI in 2012",
    "URL": "https://en.wikipedia.org/wiki/History_of_Lance_Armstrong_doping_allegations"
  },
  {
    "Time": "38:14",
    "Place": 7,
    "Seconds": 2294,
    "Name": "Miguel Indurain",
    "Year": 1995,
    "Nationality": "ESP",
    "Doping": "1994 Failed test for salbutemol, not a banned drug at that time",
    "URL": "http://www.independent.co.uk/sport/drugs-in-sport-indurain-allowed-to-use-banned-drug-1379584.html"
  },
  {
    "Time": "38:14",
    "Place": 8,
    "Seconds": 2294,
    "Name": "Alex Zülle",
    "Year": 1995,
    "Nationality": "SUI",
    "Doping": "Confessed in 1998 to taking EPO",
    "URL": "https://en.wikipedia.org/wiki/Alex_Z%C3%BClle#Festina_affair"
  },
  {
    "Time": "38:16",
    "Place": 9,
    "Seconds": 2296,
    "Name": "Bjarne Riis",
    "Year": 1995,
    "Nationality": "DEN",
    "Doping": "Alleged drug use during 1995 due to high hermatrocite levels",
    "URL": "https://en.wikipedia.org/wiki/Bjarne_Riis#Doping_allegations"
  },
  {
    "Time": "38:22",
    "Place": 10,
    "Seconds": 2302,
    "Name": "Richard Virenque",
    "Year": 1997,
    "Nationality": "FRA",
    "Doping": "In 2000 confessed to doping during his career",
    "URL": "https://en.wikipedia.org/wiki/Richard_Virenque#Festina_affair"
  },
  {
    "Time": "38:36",
    "Place": 11,
    "Seconds": 2316,
    "Name": "Floyd Landis",
    "Year": 2006,
    "Nationality": "USA",
    "Doping": "Stripped of 2006 Tour de France title",
    "URL": "https://en.wikipedia.org/wiki/Floyd_Landis_doping_case"
  },
  {
    "Time": "38:36",
    "Place": 12,
    "Seconds": 2316,
    "Name": "Andreas Klöden",
    "Year": 2006,
    "Nationality": "GER",
    "Doping": "Alleged use of illegal blood transfusions in 2006",
    "URL": "https://en.wikipedia.org/wiki/Andreas_Kl%C3%B6den#2009_Doping_allegations"
  },
  {
    "Time": "38:40",
    "Place": 13,
    "Seconds": 2320,
    "Name": "Jan Ullrich",
    "Year": 2004,
    "Nationality": "GER",
    "Doping": "Confessed later in his career to doping",
    "URL": "https://en.wikipedia.org/wiki/Jan_Ullrich#Operaci.C3.B3n_Puerto_doping_case"
  },
  {
    "Time": "38:44",
    "Place": 14,
    "Seconds": 2324,
    "Name": "Laurent Madouas",
    "Year": 1995,
    "Nationality": "FRA",
    "Doping": "Tested positive for Salbutemol in 1994, suspended for 1 month",
    "URL": "http://www.dopeology.org/incidents/Madouas-positive/"
  },
  {
    "Time": "38:55",
    "Place": 15,
    "Seconds": 2335,
    "Name": "Richard Virenque",
    "Year": 1994,
    "Nationality": "FRA",
    "Doping": "In 2000 confessed to doping during his career",
    "URL": "https://en.wikipedia.org/wiki/Richard_Virenque#Festina_affair"
  },
  {
    "Time": "39:01",
    "Place": 16,
    "Seconds": 2341,
    "Name": "Carlos Sastre",
    "Year": 2006,
    "Nationality": "ESP",
    "Doping": "",
    "URL": ""
  },
  {
    "Time": "39:09",
    "Place": 17,
    "Seconds": 2349,
    "Name": "Iban Mayo",
    "Year": 2003,
    "Nationality": "ESP",
    "Doping": "Failed doping test in 2007 Tour de France",
    "URL": "https://en.wikipedia.org/wiki/Iban_Mayo"
  },
  {
    "Time": "39:12",
    "Place": 18,
    "Seconds": 2352,
    "Name": "Andreas Klöden",
    "Year": 2004,
    "Nationality": "GER",
    "Doping": "Alleged doping during 2006 Tour de France",
    "URL": "https://en.wikipedia.org/wiki/Operaci%C3%B3n_Puerto_doping_case"
  },
  {
    "Time": "39:14",
    "Place": 19,
    "Seconds": 2354,
    "Name": "Jose Azevedo",
    "Year": 2004,
    "Nationality": "POR",
    "Doping": "Implicated in the Operación Puerto doping case",
    "URL": "https://en.wikipedia.org/wiki/Operaci%C3%B3n_Puerto_doping_case"
  },
  {
    "Time": "39:15",
    "Place": 20,
    "Seconds": 2355,
    "Name": "Levi Leipheimer",
    "Year": 2006,
    "Nationality": "USA",
    "Doping": "Testified in 2012 to doping during his time with US Postal Service ",
    "URL": "http://www.wsj.com/articles/SB10000872396390444799904578048352672452328"
  },
  {
    "Time": "39:22",
    "Place": 21,
    "Seconds": 2362,
    "Name": "Francesco Casagrande",
    "Year": 1997,
    "Nationality": "ITA",
    "Doping": "Positive testosterone test in 1998",
    "URL": "http://autobus.cyclingnews.com/results/1998/sep98/sep2.shtml"
  },
  {
    "Time": "39:23",
    "Place": 22,
    "Seconds": 2363,
    "Name": "Nairo Quintana",
    "Year": 2015,
    "Nationality": "COL",
    "Doping": "",
    "URL": ""
  },
  {
    "Time": "39:23",
    "Place": 23,
    "Seconds": 2363,
    "Name": "Bjarne Riis",
    "Year": 1997,
    "Nationality": "DEN",
    "Doping": "Alleged drug use during 1995 due to high hermatrocite levels",
    "URL": "https://en.wikipedia.org/wiki/Bjarne_Riis#Doping_allegations"
  },
  {
    "Time": "39:30",
    "Place": 24,
    "Seconds": 2370,
    "Name": "Miguel Indurain",
    "Year": 1994,
    "Nationality": "ESP",
    "Doping": "1994 Failed test for salbutemol, not a banned drug at that time",
    "URL": "http://www.independent.co.uk/sport/drugs-in-sport-indurain-allowed-to-use-banned-drug-1379584.html"
  },
  {
    "Time": "39:30",
    "Place": 25,
    "Seconds": 2370,
    "Name": "Luc Leblanc",
    "Year": 1994,
    "Nationality": "FRA",
    "Doping": "Admitted to using epo and amphetimines throughout 1994 ",
    "URL": "http://www.dopeology.org/people/Luc_Leblanc/"
  },
  {
    "Time": "39:32",
    "Place": 26,
    "Seconds": 2372,
    "Name": "Carlos Sastre",
    "Year": 2008,
    "Nationality": "ESP",
    "Doping": "",
    "URL": ""
  },
  {
    "Time": "39:37",
    "Place": 27,
    "Seconds": 2377,
    "Name": "Vladimir Poulnikov",
    "Year": 1994,
    "Nationality": "UKR",
    "Doping": "",
    "URL": ""
  },
  {
    "Time": "39:40",
    "Place": 28,
    "Seconds": 2380,
    "Name": "Giuseppe Guerini",
    "Year": 2004,
    "Nationality": "ITA",
    "Doping": "",
    "URL": ""
  },
  {
    "Time": "39:41",
    "Place": 29,
    "Seconds": 2381,
    "Name": "Santos Gonzalez",
    "Year": 2004,
    "Nationality": "ESP",
    "Doping": "High Hematocrit during 2005 season, removed by team management",
    "URL": "http://www.cyclingnews.com/news/santos-gonzalez-sacked-by-phonak/"
  },
  {
    "Time": "39:41",
    "Place": 30,
    "Seconds": 2381,
    "Name": "Vladimir Karpets",
    "Year": 2004,
    "Nationality": "RUS",
    "Doping": "Made payments to Ferrari, but no charges filed",
    "URL": "http://www.dopeology.org/incidents/Ferrari-investigation/"
  },
  {
    "Time": "39:45",
    "Place": 31,
    "Seconds": 2385,
    "Name": "Fernando Escartin",
    "Year": 1995,
    "Nationality": "ESP",
    "Doping": "Implicated in Giardini Margherita Raid in 1998 as a 'victim' ",
    "URL": "http://www.dopeology.org/incidents/Giardini-Margherita-raid-%5bBologna%5d/"
  },
  {
    "Time": "39:47",
    "Place": 32,
    "Seconds": 2387,
    "Name": "Denis Menchov",
    "Year": 2006,
    "Nationality": "RUS",
    "Doping": "",
    "URL": ""
  },
  {
    "Time": "39:47",
    "Place": 33,
    "Seconds": 2387,
    "Name": "Michael Rasmussen",
    "Year": 2006,
    "Nationality": "DEN",
    "Doping": "Admitted to doping with multiple substances 1998-2010",
    "URL": "http://www.dopeology.org/people/Michael_Rasmussen/"
  },
  {
    "Time": "39:47",
    "Place": 34,
    "Seconds": 2387,
    "Name": "Pietro Caucchioli",
    "Year": 2006,
    "Nationality": "ITA",
    "Doping": "Associated with Mantova investigation, charges dropped",
    "URL": "http://www.cyclingnews.com/news/italian-judge-set-to-decide-if-32-named-in-mantova-doping-investigation-should-go-on-trial/"
  },
  {
    "Time": "39:50",
    "Place": 35,
    "Seconds": 2390,
    "Name": "Nairo Quintana",
    "Year": 2013,
    "Nationality": "COL",
    "Doping": "",
    "URL": ""
  }
];


//// This sets up the SVG chart dimensions ////

var margin = {top: 20, right: 20, bottom: 80, left: 80};
var chartWidth = 800;
var chartHeight = 800;
var contWidth = chartWidth - margin.left - margin.right;
var contHeight = chartHeight - margin.top - margin.bottom;
var minTime = dataObjs[0].Seconds;
var minRank = dataObjs[0].Place;
var maxTime = dataObjs[dataObjs.length-1].Seconds;
var maxRank = dataObjs[dataObjs.length-1].Place;

//// This sets the x and y scales for the plot ////

var xScale = d3.scale.linear()
    .domain([1+(maxTime-minTime)/60,0])
    .range([0,contWidth]);

var yScale = d3.scale.linear()
    .domain([minRank,maxRank+1])
   .range([0,contHeight]);

//// This sets the x and y scales for the plot ////

var xAxis = d3.svg.axis()
    .scale(xScale)
    .tickPadding(10)
    .orient("bottom");
    
var yAxis = d3.svg.axis()
    .scale(yScale)
    .tickPadding(10)
    .orient("left");

//// This selects the SVG with D3 and sets its size using a viewBox rather than absolute height and width. This allows the SVG to resize on the page, and everything within the SVG will adjust accordingly. This then adds axes and axis labels ////

var chart = d3.select(".chart")
    .attr("viewBox", "0 0 " + chartWidth + " " + chartHeight);

chart.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(" + margin.left + "," + (contHeight + margin.top) + ")")
    .call(xAxis);

chart.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    .call(yAxis);

chart.append("text")
    .attr("class", "axisLabel")
    .attr("x", chartWidth / 3 + 50)
    .attr("y", contHeight + margin.top + margin.bottom - 20)
    .text("Minutes Behind Fastest Rider");

chart.append("text")
    .attr("class", "axisLabel")
    .attr("x", -(contWidth/3 + 140))
    .attr("y", 30)
    .attr("transform", "rotate(-90)")
    .text("Rank");

//// This adds the symbol key ////

var keyX = 560;
var keyY = 650;
var keyWidth = 220;
var keyHeight = 60;
var circleX = 20 + keyX;
var circleYtop = keyY + (keyHeight / 3);
var circleYbot = keyY + 2*(keyHeight / 3);
var textX = circleX + 30;
var textYtop = circleYtop + 5;
var textYbot = circleYbot + 5;

chart.append("rect")
    .attr("class", "keyBack")
    .attr("height", keyHeight)
    .attr("width", keyWidth)
    .attr("transform", "translate(" + keyX + " " + keyY + ")");

chart.append("circle")
    .attr("class", "dopedSymb")
    .attr("transform", "translate(" + circleX + " " + circleYtop + ")")
    .attr("r",8);

chart.append("circle")
    .attr("class", "noDopedSymb")
    .attr("transform", "translate(" + circleX + " " + circleYbot + ")")
    .attr("r",8);

chart.append("text")
    .attr("class", "keyLabel")
    .attr("x", textX)
    .attr("y", textYtop)
    .text("Riders accused of doping");

chart.append("text")
    .attr("class", "keyLabel")
    .attr("x", textX)
    .attr("y", textYbot)
    .text("Riders not accused of doping");

//// This adds a single box as a background for each data point info label ////

var backX = 90;
var backY = 20;
var backWidth = 380;
var backHeight = 70;

chart.append("rect")
    .attr("class", "labelBack")
    .attr("width", backWidth)
    .attr("height", backHeight)  
    .attr("transform", "translate(" + backX + "," + backY + ")"); 

//// This adds a group for each item in the data array, appending one if it doesn't exist, and it positions the group in space based on the x and y of the data point ////

var dataPts = chart.selectAll(".dataPts")
    .data(dataObjs)
    .enter().append("g")
    .attr("class", "dataPts")
    .attr("transform", function(d) { 
      var xPos = xScale((d.Seconds-minTime)/60) + margin.left;
      var yPos = yScale(d.Place) + margin.top;
      return "translate(" + xPos + "," + yPos + ")"; 
    });

//// This then appends a circle element to each data point group in the correct x,y location ////

dataPts.append("circle")
    .attr("class", function(d) {
      if (d.Doping) {
        return "dopedSymb";
      } else {
        return "noDopedSymb";
      }
    })
    .attr("r",8);

//// This adds the rider name next to each symbol ////

dataPts.append("text")
    .attr("class", "riderName")
    .attr("x", -15)
    .attr("y", 3)
    .text(function(d) {
      return d.Name; 
    });

//// This adds three text labels for each data point onto the background created earlier (rather than use tspans) ////

var labelXshift = 10;
var labelYtopshift = 20;
var labelYmidshift = 40;
var labelYbotshift = 60;

dataPts.append("text")
    .attr("class", "labelText")
    .attr("x", function(d) { 
      var xPos = -xScale((d.Seconds-minTime)/60)-margin.left + backX + labelXshift; 
      return xPos;
    })
    .attr("y", function(d) { 
      var yPos = -yScale(d.Place) - margin.top + backY + labelYtopshift;
      return yPos;
    })
    .text(function(d) {
      return d.Name + " (" + d.Nationality + ")"; 
    });

dataPts.append("text")
    .attr("class", "labelText")
    .attr("x", function(d) { 
      var xPos = -xScale((d.Seconds-minTime)/60)-margin.left + backX + labelXshift; 
      return xPos;
    })
    .attr("y", function(d) { 
      var yPos = -yScale(d.Place) - margin.top + backY + labelYmidshift;
      return yPos;
    })
    .text(function(d) {
      return "Year: " + d.Year + ", Time: " + d.Time; 
    });

dataPts.append("text")
    .attr("class", "labelText")
    .attr("x", function(d) { 
      var xPos = -xScale((d.Seconds-minTime)/60)-margin.left + backX + labelXshift; 
      return xPos;
    })
    .attr("y", function(d) { 
      var yPos = -yScale(d.Place) - margin.top + backY + labelYbotshift;
      return yPos;
    })
    .text(function(d) {
      if (d.Doping) {
        return d.Doping;
      } else {
        return "No doping allegations for this rider";
      }
    });

dataPts.append("title")
    .text(function(d) {
      return d.Name + " (" + d.Nationality + ") Year: " + d.Year + ", Time: " + d.Time + "   " + d.Doping; 
    })

//// These are the mouse and click events that will add interactivity to the chart ////

function mouseOn() {
  var circleRef = this.childNodes[0];
  var backRef = document.getElementsByClassName("labelBack");
  var textRefA = this.childNodes[2];
  var textRefB = this.childNodes[3];
  var textRefC = this.childNodes[4];
  circleRef.style.fill = 'yellow';
  backRef[0].style.visibility = "visible";
  textRefA.style.visibility = "visible";
  textRefB.style.visibility = "visible";
  textRefC.style.visibility = "visible";
}

function mouseOff() {
  var circleRef = this.childNodes[0];
  var backRef = document.getElementsByClassName("labelBack");
  var textRefA = this.childNodes[2];
  var textRefB = this.childNodes[3];
  var textRefC = this.childNodes[4];
  var colorToSet = '';
  if (circleRef.getAttribute('class') == "dopedSymb") {
    colorToSet = '#3cc47c';
  } else {
    colorToSet = '#1e392a';
  }
  circleRef.style.fill = colorToSet;
  backRef[0].style.visibility = "hidden";
  textRefA.style.visibility = "hidden";
  textRefB.style.visibility = "hidden";
  textRefC.style.visibility = "hidden";
}

//// This binds the click and mouse events to each bar ////

function bindEvents() {
  var dataPtSet = document.getElementsByClassName('dataPts');
  for (var i = 0; i < dataPtSet.length; i++) {
    dataPtSet[i].onmouseover = mouseOn;
    dataPtSet[i].onmouseout = mouseOff;
  }
}
bindEvents();